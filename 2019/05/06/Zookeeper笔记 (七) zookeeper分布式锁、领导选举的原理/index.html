
<!DOCTYPE html>
<html lang class="loading">
<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Zookeeper笔记 (七) zookeeper分布式锁、领导选举的原理 - 朝阳的博客</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="google" content="notranslate">
    <meta name="keywords" content="Sunny,"> 
    <meta name="description" content="本文参考地址：【Zookeeper 学习笔记】—实例详解ZooKeeper ZAB协议、分布式锁与领导选举

分布式锁与领导选举关键点



最多一个获取锁 / 成为Leader


对于分布式锁（,"> 
    <meta name="author" content="Sunny___"> 
    <link rel="alternative" href="atom.xml" title="朝阳的博客" type="application/atom+xml"> 
    <link rel="icon" href="/img/favicon.png"> 
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
    <link rel="stylesheet" href="/css/diaspora.css">
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
         (adsbygoogle = window.adsbygoogle || []).push({
              google_ad_client: "ca-pub-8691406134231910",
              enable_page_level_ads: true
         });
    </script>
    <script async custom-element="amp-auto-ads" src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
</head>
</html>
<body class="loading">
    <span id="config-title" style="display:none">朝阳的博客</span>
    <div id="loader"></div>
    <div id="single">
    <div id="top" style="display: block;">
    <div class="bar" style="width: 0;"></div>
    <a class="icon-home image-icon" href="javascript:;" data-url="http://yoursite.com"></a>
    <div title="播放/暂停" class="icon-play"></div>
    <h3 class="subtitle">Zookeeper笔记 (七) zookeeper分布式锁、领导选举的原理</h3>
    <div class="social">
        <!--<div class="like-icon">-->
            <!--<a href="javascript:;" class="likeThis active"><span class="icon-like"></span><span class="count">76</span></a>-->
        <!--</div>-->
        <div>
            <div class="share">
                <a title="获取二维码" class="icon-scan" href="javascript:;"></a>
            </div>
            <div id="qr"></div>
        </div>
    </div>
    <div class="scrollbar"></div>
</div>

    <div class="section">
        <div class="article">
    <div class="main">
        <h1 class="title">Zookeeper笔记 (七) zookeeper分布式锁、领导选举的原理</h1>
        <div class="stuff">
            <span>五月 06, 2019</span>
            
  <ul class="post-tags-list"><li class="post-tags-list-item"><a class="post-tags-list-link" href="/tags/ZAB/">ZAB</a></li><li class="post-tags-list-item"><a class="post-tags-list-link" href="/tags/zookeeper/">zookeeper</a></li></ul>


        </div>
        <div class="content markdown">
            <p>本文参考地址：<a href="http://cmsblogs.com/?p=4113" target="_blank" rel="noopener">【Zookeeper 学习笔记】—实例详解ZooKeeper ZAB协议、分布式锁与领导选举</a></p>
<ul>
<li><h3 id="分布式锁与领导选举关键点"><a href="#分布式锁与领导选举关键点" class="headerlink" title="分布式锁与领导选举关键点"></a>分布式锁与领导选举关键点</h3></li>
</ul>
<blockquote>
<ul>
<li><h5 id="最多一个获取锁-成为Leader"><a href="#最多一个获取锁-成为Leader" class="headerlink" title="最多一个获取锁 / 成为Leader"></a>最多一个获取锁 / 成为Leader</h5></li>
</ul>
</blockquote>
<p>对于分布式锁（这里特指排它锁）而言，任意时刻，最多只有一个进程（对于单进程内的锁而言是单线程）可以获得锁。</p>
<p>对于领导选举而言，任意时间，最多只有一个成功当选为Leader。否则即出现脑裂（Split brain）</p>
<blockquote>
<ul>
<li><h5 id="锁重入-确认自己是Leader"><a href="#锁重入-确认自己是Leader" class="headerlink" title="锁重入 / 确认自己是Leader"></a>锁重入 / 确认自己是Leader</h5></li>
</ul>
</blockquote>
<p>对于分布式锁，需要保证获得锁的进程在释放锁之前可再次获得锁，即锁的可重入性。</p>
<p>对于领导选举，Leader需要能够确认自己已经获得领导权，即确认自己是Leader。</p>
<blockquote>
<ul>
<li><h5 id="释放锁-放弃领导权"><a href="#释放锁-放弃领导权" class="headerlink" title="释放锁 / 放弃领导权"></a>释放锁 / 放弃领导权</h5></li>
</ul>
</blockquote>
<p>锁的获得者应该能够正确释放已经获得的锁，并且当获得锁的进程宕机时，锁应该自动释放，从而使得其他竞争方可以获得该锁，从而避免出现死锁的状态。</p>
<p>领导应该可以主动放弃领导权，并且当领导所在进程宕机时，领导权应自动释放，从而使得其他竞争方可以重新竞争领导而避免进入无主状态</p>
<blockquote>
<ul>
<li><h5 id="感知锁释放-领导权的放弃"><a href="#感知锁释放-领导权的放弃" class="headerlink" title="感知锁释放 / 领导权的放弃"></a>感知锁释放 / 领导权的放弃</h5></li>
</ul>
</blockquote>
<p>当获得锁的一方释放锁时，其它对于锁的竞争方需要能够感知到锁的释放，并再次尝试获取锁。</p>
<p>原来的Leader放弃领导权时，其它参与方应该能够感知该事件，并重新发起选举流程。</p>
<ul>
<li><h3 id="非公平领导选举"><a href="#非公平领导选举" class="headerlink" title="非公平领导选举"></a>非公平领导选举</h3></li>
</ul>
<p>分布式锁与领导选举的技术要点非常相似，这里以领导选举为例来说明二者的实现原理</p>
<blockquote>
<ul>
<li><h5 id="选主过程"><a href="#选主过程" class="headerlink" title="选主过程"></a>选主过程</h5></li>
</ul>
</blockquote>
<p>假设有三个zk客户端同时竞争leader，这三个客户端同时向zk集群注册临时节点（Ephemeral）且无序类型（Non-sequence）的节点。路径都为 /zkroot/leader (路径名自定义)</p>
<p><img src="https://gitee.com/chenssy/blog-home/raw/master/image/series-images/zookeeper/2ae468645d9a457b8f6a0bc6701ae9e9.jpeg" alt="image"></p>
<p>由于是无序节点，这三个客户端只会有一个创建成功，其他节点均创建失败。此时，创建成功的客户端1即成功竞选为Leader。其他客户端此时均为Follower。</p>
<blockquote>
<ul>
<li><h5 id="放弃领导权"><a href="#放弃领导权" class="headerlink" title="放弃领导权"></a>放弃领导权</h5></li>
</ul>
</blockquote>
<p>如果Leader打算放弃领导权，直接删除/zkroot/leader节点即可。</p>
<p>如果Leader进程意外宕机，其与zk间的session也就结束，该临时节点自动删除。</p>
<p>此时 /zkroot/leader节点不存在了，对于其他竞选的客户端而言，之前的Leader放弃了领导权。</p>
<blockquote>
<ul>
<li><h5 id="感知领导权的放弃"><a href="#感知领导权的放弃" class="headerlink" title="感知领导权的放弃"></a>感知领导权的放弃</h5></li>
</ul>
</blockquote>
<p>创建节点失败的节点，除了成为Follower之外，还会向 /zkroot/leader注册一个Watcher，一旦Leader放弃领导权，节点被删除，所有的FOllower都会收到通知。</p>
<blockquote>
<ul>
<li><h5 id="重新选举"><a href="#重新选举" class="headerlink" title="重新选举"></a>重新选举</h5></li>
</ul>
</blockquote>
<p>感知到旧Leader放弃领导权后，所有的FOllower可以再次发起一轮领导选举：</p>
<p><img src="https://gitee.com/chenssy/blog-home/raw/master/image/series-images/zookeeper/67966be66521475e93bed856ac5584df.jpeg" alt="image"></p>
<p>新一轮的领导选举方法与最初的领导选举方法完全一样。由于选举结果无法预测，与他们在第一轮选举的顺序无关，所以这种方案才被称为非公平锁</p>
<blockquote>
<ul>
<li><h5 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h5></li>
</ul>
</blockquote>
<p>非公平锁实现简单，每一轮选举方法都一样。竞争方不多的情况下，效率高。若竞争方有上万的话，同时参与竞选就意味着同时会有上万个请求发给zk。由于zk存在单点写的问题，写性能不高。同时Leader放弃领导，zk还需要同时通知上万个FOllower，负载较大。</p>
<ul>
<li><h3 id="公平领导选举"><a href="#公平领导选举" class="headerlink" title="公平领导选举"></a>公平领导选举</h3></li>
</ul>
<blockquote>
<ul>
<li><h5 id="选主过程-1"><a href="#选主过程-1" class="headerlink" title="选主过程"></a>选主过程</h5></li>
</ul>
</blockquote>
<p>公平领导选举中，各客户端创建 /zkroot/leader节点，且类型为临时顺序节点。</p>
<p><img src="https://gitee.com/chenssy/blog-home/raw/master/image/series-images/zookeeper/6789a44c37454f5e9712d0e6ac34bf6e.jpeg" alt="image"></p>
<p>由于是顺序类型节点，所以各客户端均创建成功。每个客户端会判断自己创建的节点序号是否是当前最小的。如果是，则该客户端成为leader，否则为FOllower。这里客户端1成为leader。</p>
<blockquote>
<ul>
<li><h5 id="放弃领导权-1"><a href="#放弃领导权-1" class="headerlink" title="放弃领导权"></a>放弃领导权</h5></li>
</ul>
</blockquote>
<p>leader如果主动放弃领导权，直接删除其创建的节点即可。</p>
<p>如果leader所在进程意外宕机，session会话结束，其创建的临时节点会自动删除。</p>
<blockquote>
<ul>
<li><h5 id="感知领导权的放弃-1"><a href="#感知领导权的放弃-1" class="headerlink" title="感知领导权的放弃"></a>感知领导权的放弃</h5></li>
</ul>
</blockquote>
<p>与非公平模式不同，每个FOllower并非都watch由leader创建出来的节点，而是watch刚好比自己序号小的节点。</p>
<p>一旦leader宕机，/zkroot/leader1删除，客户端2可得到通知。此时客户端3由于watch的是 /zkroot/leader2，所以不会得到通知。</p>
<blockquote>
<ul>
<li><h5 id="重新选举-1"><a href="#重新选举-1" class="headerlink" title="重新选举"></a>重新选举</h5></li>
</ul>
</blockquote>
<p>客户端2得到 /zkroot/leader1被删除的通知后，不会立即成为新的leader。而是先判断自己的序号2是不是当前最小的。如果是最小的，客户端2就会成为新的leader。</p>
<p><img src="https://gitee.com/chenssy/blog-home/raw/master/image/series-images/zookeeper/065670a367bd4a548cb98fe7d990cf57.jpeg" alt="image"></p>
<p><code>注意：</code>如果客户端1放弃领导权之前，客户端2宕机，客户端3会收到通知。此时客户端3不会立即成为新的leader，而是判断自己的序号是否是最小的。由于此时 /zkroot/leader1还在，因此客户端3不会成为新的leader，并向 /zkroot/leader1节点创建watch。</p>
<p><img src="https://gitee.com/chenssy/blog-home/raw/master/image/series-images/zookeeper/361658e79aa8421db21fcbe4811f4d35.jpeg" alt="image"></p>
<blockquote>
<ul>
<li><h5 id="小结-1"><a href="#小结-1" class="headerlink" title="小结"></a>小结</h5></li>
</ul>
</blockquote>
<p>实现相对复杂。</p>
<p>扩展性好，每个客户端都只watch一个节点且每次节点被删除只会通知一个客户端。</p>
<p>旧leader放弃领导权时，其他客户端按节点序号的先后顺序成为新leader，这也是公平模式的由来。</p>
<p>延迟相对非公平模式要高，因为它必须等待特定节点得到通知才能选出新的leader</p>
<ul>
<li><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3></li>
</ul>
<p>zk的领导选举或分布式锁的实现均基于zk节点的特性和通知机制。</p>

            <!--[if lt IE 9]><script>document.createElement('audio');</script><![endif]-->
            <audio id="audio" loop="1" preload="auto" controls="controls" data-autoplay="false">
                <source type="audio/mpeg" src>
            </audio>
            
                <ul id="audio-list" style="display:none">
                    
                        <li title="0" data-url="http://link.hhtjim.com/163/5146554.mp3"></li>
                    
                        <li title="1" data-url="http://link.hhtjim.com/qq/001faIUs4M2zna.mp3"></li>
                    
                </ul>
            
        </div>
        

    </div>
    
        <div class="side">
            <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#分布式锁与领导选举关键点"><span class="toc-number">1.</span> <span class="toc-text">分布式锁与领导选举关键点</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#最多一个获取锁-成为Leader"><span class="toc-number">1.0.1.</span> <span class="toc-text">最多一个获取锁 / 成为Leader</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#锁重入-确认自己是Leader"><span class="toc-number">1.0.2.</span> <span class="toc-text">锁重入 / 确认自己是Leader</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#释放锁-放弃领导权"><span class="toc-number">1.0.3.</span> <span class="toc-text">释放锁 / 放弃领导权</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#感知锁释放-领导权的放弃"><span class="toc-number">1.0.4.</span> <span class="toc-text">感知锁释放 / 领导权的放弃</span></a></li></ol></li></ol><li class="toc-item toc-level-3"><a class="toc-link" href="#非公平领导选举"><span class="toc-number">2.</span> <span class="toc-text">非公平领导选举</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#选主过程"><span class="toc-number">2.0.1.</span> <span class="toc-text">选主过程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#放弃领导权"><span class="toc-number">2.0.2.</span> <span class="toc-text">放弃领导权</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#感知领导权的放弃"><span class="toc-number">2.0.3.</span> <span class="toc-text">感知领导权的放弃</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#重新选举"><span class="toc-number">2.0.4.</span> <span class="toc-text">重新选举</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#小结"><span class="toc-number">2.0.5.</span> <span class="toc-text">小结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#公平领导选举"><span class="toc-number">3.</span> <span class="toc-text">公平领导选举</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#选主过程-1"><span class="toc-number">3.0.1.</span> <span class="toc-text">选主过程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#放弃领导权-1"><span class="toc-number">3.0.2.</span> <span class="toc-text">放弃领导权</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#感知领导权的放弃-1"><span class="toc-number">3.0.3.</span> <span class="toc-text">感知领导权的放弃</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#重新选举-1"><span class="toc-number">3.0.4.</span> <span class="toc-text">重新选举</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#小结-1"><span class="toc-number">3.0.5.</span> <span class="toc-text">小结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#总结"><span class="toc-number">4.</span> <span class="toc-text">总结</span></a></li>
        </div>
    
</div>


    </div>
</div>
</body>
<script src="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
<script src="//lib.baomitu.com/jquery/1.8.3/jquery.min.js"></script>
<script src="/js/plugin.js"></script>
<script src="/js/diaspora.js"></script>
<link rel="stylesheet" href="/photoswipe/photoswipe.css">
<link rel="stylesheet" href="/photoswipe/default-skin/default-skin.css">
<script src="/photoswipe/photoswipe.min.js"></script>
<script src="/photoswipe/photoswipe-ui-default.min.js"></script>

<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>
    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">
        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>
        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <!--  Controls are self-explanatory. Order can be changed. -->
                <div class="pswp__counter"></div>
                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>
            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>
            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>
            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>




</html>
